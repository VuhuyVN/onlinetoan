<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Phòng họp online miễn phí</title>
  <style>
    body { font-family: sans-serif; text-align: center; background: #1e1e1e; color: white; }
    video { width: 45%; margin: 10px; border-radius: 12px; background: black; }
    button { margin: 10px; padding: 10px 15px; border: none; border-radius: 6px; background: #3b82f6; color: white; cursor: pointer; }
    button:hover { background: #2563eb; }
  </style>
</head>
<body>
  <h2>🎥 Phòng họp trực tuyến</h2>
  <video id="localVideo" autoplay muted playsinline></video>
  <video id="remoteVideo" autoplay playsinline></video><br>
  <button id="shareScreen">🖥️ Chia sẻ màn hình</button>
  <button id="copyLink">📋 Sao chép link phòng</button>

  <script>
    const room = location.hash.substring(1) || Math.random().toString(36).substring(2, 9);
    if (!location.hash) location.hash = room;
    const servers = { iceServers: [{ urls: 'stun:stun.l.google.com:19302' }] };
    const pc = new RTCPeerConnection(servers);
    const localVideo = document.getElementById('localVideo');
    const remoteVideo = document.getElementById('remoteVideo');
    const shareBtn = document.getElementById('shareScreen');
    const copyBtn = document.getElementById('copyLink');

    navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(stream => {
      localVideo.srcObject = stream;
      stream.getTracks().forEach(track => pc.addTrack(track, stream));
    });

    pc.ontrack = e => remoteVideo.srcObject = e.streams[0];

    const ws = new WebSocket('wss://ws.postman-echo.com/raw'); // server relay miễn phí
    ws.onmessage = async e => {
      const msg = JSON.parse(e.data);
      if (msg.room !== room) return;
      if (msg.offer) {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.offer));
        const answer = await pc.createAnswer();
        await pc.setLocalDescription(answer);
        ws.send(JSON.stringify({ answer, room }));
      } else if (msg.answer) {
        await pc.setRemoteDescription(new RTCSessionDescription(msg.answer));
      } else if (msg.candidate) {
        await pc.addIceCandidate(new RTCIceCandidate(msg.candidate));
      }
    };
    pc.onicecandidate = e => e.candidate && ws.send(JSON.stringify({ candidate: e.candidate, room }));

    (async () => {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      ws.onopen = () => ws.send(JSON.stringify({ offer, room }));
    })();

    shareBtn.onclick = async () => {
      const stream = await navigator.mediaDevices.getDisplayMedia({ video: true });
      const track = stream.getVideoTracks()[0];
      const sender = pc.getSenders().find(s => s.track.kind === 'video');
      sender.replaceTrack(track);
      track.onended = () => sender.replaceTrack(localVideo.srcObject.getVideoTracks()[0]);
    };

    copyBtn.onclick = () => {
      navigator.clipboard.writeText(location.href);
      alert('Đã sao chép link phòng!\nGửi link này cho người khác để vào chung.');
    };
  </script>
</body>
</html>
